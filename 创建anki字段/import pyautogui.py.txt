import pyautogui
import time

# ================== é…ç½®éƒ¨åˆ† ==================
# ä»ä½ç½®.txtä¸­è¯»å–åæ ‡ï¼ˆè‡ªåŠ¨å¤„ç†ä¸­æ–‡ç¬¦å·å’Œç©ºæ ¼ï¼‰
def parse_positions(filename):
    positions = {}
    with open(filename, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip().replace('ï¼Œ', ',')  # æ›¿æ¢ä¸­æ–‡é€—å·ä¸ºè‹±æ–‡é€—å·
            if 'ä½ç½®1' in line:
                x = int(line.split('x=')[1].split(',')[0])
                y = int(line.split('y=')[1])
                positions['position1'] = (x, y)
            elif 'ä½ç½®2' in line:
                x = int(line.split('x=')[1].split(',')[0])
                y = int(line.split('y=')[1])
                positions['position2'] = (x, y)
            elif 'ä½ç½®3' in line:
                x = int(line.split('x=')[1].split(',')[0])
                y = int(line.split('y=')[1])
                positions['position3'] = (x, y)
    return positions

# ä»å†…å®¹æ–‡ä»¶ä¸­è¯»å–æ‰€æœ‰éœ€è¦è¾“å…¥çš„å†…å®¹
def parse_contents(filename):
    contents = []
    with open(filename, 'r', encoding='utf-8') as f:
        for line in f:
            # ç§»é™¤ç‰¹æ®Šå­—ç¬¦å¹¶åˆ†å‰²å­—æ®µ
            clean_line = line.strip().replace('\ufeff', '')
            fields = clean_line.split('\t')
            # å°†å­—æ®µç»„åˆæˆç»“æ„åŒ–æ•°æ®
            structured_content = []
            for i in range(0, len(fields), 10):  # æ¯10ä¸ªå­—æ®µä¸ºä¸€ç»„å®Œæ•´å†…å®¹
                group = fields[i:i+10]
                if len(group) >= 10:
                    structured_content.append({
                        'meaning': group[0],
                        'explanation': group[1],
                        'phrase1': group[2],
                        'example1': group[3],
                        'phrase2': group[4],
                        'example2': group[5],
                        'phrase3': group[6],
                        'example3': group[7],
                        'phrase4': group[8],
                        'example4': group[9]
                    })
            contents.extend(structured_content)
    return contents

# ================== æ ¸å¿ƒé€»è¾‘ ==================
def click_position(x, y):
    """ç²¾ç¡®ç‚¹å‡»æŒ‡å®šåæ ‡"""
    pyautogui.moveTo(x, y, duration=0.3)
    pyautogui.click()
    print(f"âœ… å·²ç‚¹å‡» ({x}, {y})")
    time.sleep(0.5)

def type_content(content):
    """æ™ºèƒ½è¾“å…¥å†…å®¹ï¼ˆè‡ªåŠ¨æ¢è¡Œ+æ ¼å¼ä¼˜åŒ–ï¼‰"""
    # æ„å»ºå¸¦æ ¼å¼çš„å†…å®¹
    formatted_text = f"""
    ã€é‡Šä¹‰ã€‘{content['meaning']}
    {content['explanation']}
    
    ã€è¯ç»„1ã€‘{content['phrase1']}
    {content['example1']}
    
    ã€è¯ç»„2ã€‘{content['phrase2']}
    {content['example2']}
    
    ã€è¯ç»„3ã€‘{content['phrase3']}
    {content['example3']}
    
    ã€è¯ç»„4ã€‘{content['phrase4']}
    {content['example4']}
    """
    pyautogui.write(formatted_text.strip(), interval=0.05)
    print(f"ğŸ“ å·²è¾“å…¥å†…å®¹: {content['meaning'][:20]}...")
    time.sleep(0.2)

def execute_workflow(positions, contents):
    """æ‰§è¡Œå®Œæ•´å·¥ä½œæµç¨‹"""
    try:
        for idx, content in enumerate(contents, 1):
            print(f"\n====== æ­£åœ¨å¤„ç†ç¬¬ {idx}/{len(contents)} æ¡ ======")
            
            # ç¬¬ä¸€é˜¶æ®µï¼šä½ç½®1ç‚¹å‡»
            click_position(*positions['position1'])
            
            # ç¬¬äºŒé˜¶æ®µï¼šä½ç½®2ç‚¹å‡»å¹¶è¾“å…¥
            click_position(*positions['position2'])
            type_content(content)
            
            # ç¬¬ä¸‰é˜¶æ®µï¼šä½ç½®3ç¡®è®¤
            click_position(*positions['position3'])
            
            print(f"âœ”ï¸ å·²å®Œæˆ {idx}/{len(contents)}")
            
    except pyautogui.FailSafeException:
        print("\nâš ï¸ å®‰å…¨æœºåˆ¶è§¦å‘ï¼šé¼ æ ‡ç§»åŠ¨åˆ°å±å¹•å·¦ä¸Šè§’ç»ˆæ­¢æ“ä½œ")

# ================== æ‰§è¡Œç¨‹åº ==================
if __name__ == "__main__":
    # è¯»å–é…ç½®æ–‡ä»¶
    positions = parse_positions(r"C:\Users\Qfyun\Desktop\åˆ›å»ºankiå­—æ®µ\ä½ç½®.txt")
    contents = parse_contents(r"C:\Users\Qfyun\Desktop\åˆ›å»ºankiå­—æ®µ\æ°´å¹³æ’åˆ—_æ— è¯æ€§.txt")
    
    # å®‰å…¨æ£€æŸ¥
    print("=== ç³»ç»Ÿæ£€æŸ¥ ===")
    print(f"å®šä½åˆ° {len(positions)} ä¸ªåæ ‡ä½ç½®")
    print(f"å‘ç° {len(contents)} æ¡å¾…å¤„ç†å†…å®¹")
    input("æŒ‰ Enter å¼€å§‹æ‰§è¡Œï¼ˆ5ç§’åå¯åŠ¨ï¼Œè¯·ä¿æŒçª—å£ç„¦ç‚¹ï¼‰...")
    time.sleep(5)
    
    # æ‰§è¡Œä¸»ç¨‹åº
    execute_workflow(positions, contents)
    
    print("\nğŸ‰ æ‰€æœ‰å†…å®¹å¤„ç†å®Œæˆï¼")